var extendStatics=function(d,b){return extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)Object.prototype.hasOwnProperty.call(b,p)&&(d[p]=b[p])},extendStatics(d,b)},__assign=function(){return __assign=Object.assign||function(t){for(var s,i=1,n=arguments.length;i<n;i++)for(var p in s=arguments[i])Object.prototype.hasOwnProperty.call(s,p)&&(t[p]=s[p]);return t},__assign.apply(this,arguments)};function __awaiter(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P(function(resolve){resolve(value)})).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})}function __generator(thisArg,body){var f,y,t,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]},g=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return g.next=verb(0),g.throw=verb(1),g.return=verb(2),"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;g&&(g=0,op[0]&&(_=0)),_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!((t=(t=_.trys).length>0&&t[t.length-1])||6!==op[0]&&2!==op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}}function __spreadArray(to,from,pack){if(pack||2===arguments.length)for(var ar,i=0,l=from.length;i<l;i++)!ar&&i in from||(ar||(ar=Array.prototype.slice.call(from,0,i)),ar[i]=from[i]);return to.concat(ar||Array.prototype.slice.call(from))}function generateVisitorId(){return"v_"+generateRandomId(16)}function generateSessionId(){return"s_"+generateRandomId(12)+"_"+Date.now()}function generateRandomId(length){for(var result="",i=0;i<length;i++)result+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(Math.floor(62*Math.random()));return result}function now(){return Date.now()}function debounce(func,wait){var timeout;return function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];clearTimeout(timeout),timeout=window.setTimeout(function(){return func.apply(void 0,args)},wait)}}function throttle(func,limit){var inThrottle;return function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];inThrottle||(func.apply(void 0,args),inThrottle=!0,setTimeout(function(){return inThrottle=!1},limit))}}function isBrowser(){return"undefined"!=typeof window&&"undefined"!=typeof document}function isProduction(){return"production"===process.env.NODE_ENV}function safeJsonParse(str,fallback){try{return JSON.parse(str)}catch(_a){return fallback}}function safeJsonStringify(obj){try{return JSON.stringify(obj)}catch(_a){return"{}"}}function getCurrentUrl(){return isBrowser()?window.location.href.split("#")[0].split("?")[0]:""}function getCurrentTitle(){return isBrowser()&&document.title||""}function getReferrer(){return isBrowser()&&document.referrer||""}function getUserAgent(){return isBrowser()&&navigator.userAgent||""}function detectPlatform(){if(!isBrowser())return"server";var userAgent=getUserAgent().toLowerCase();return/android/.test(userAgent)?"android":/iphone|ipad|ipod/.test(userAgent)?"ios":/windows/.test(userAgent)?"windows":/mac/.test(userAgent)?"mac":/linux/.test(userAgent)?"linux":"unknown"}function detectBrowser(){if(!isBrowser())return"unknown";var userAgent=getUserAgent().toLowerCase();return/chrome/.test(userAgent)&&!/edge/.test(userAgent)?"chrome":/firefox/.test(userAgent)?"firefox":/safari/.test(userAgent)&&!/chrome/.test(userAgent)?"safari":/edge/.test(userAgent)?"edge":/opera/.test(userAgent)?"opera":"unknown"}function isElementVisible(element){if(!isBrowser())return!1;var rect=element.getBoundingClientRect(),windowHeight=window.innerHeight||document.documentElement.clientHeight,windowWidth=window.innerWidth||document.documentElement.clientWidth;return rect.top>=0&&rect.left>=0&&rect.bottom<=windowHeight&&rect.right<=windowWidth}function getScrollDepth(){if(!isBrowser())return 0;var scrollTop=window.pageYOffset||document.documentElement.scrollTop,documentHeight=Math.max(document.body.scrollHeight,document.body.offsetHeight,document.documentElement.clientHeight,document.documentElement.scrollHeight,document.documentElement.offsetHeight),windowHeight=window.innerHeight||document.documentElement.clientHeight;return documentHeight<=windowHeight?100:Math.round((scrollTop+windowHeight)/documentHeight*100)}function domReady(callback){isBrowser()&&"loading"===document.readyState?document.addEventListener("DOMContentLoaded",callback):callback()}function addEventListener(element,event,handler,options){return element.addEventListener(event,handler,options),function(){return element.removeEventListener(event,handler,options)}}function simpleHash(str){var hash=0;if(0===str.length)return hash;for(var i=0;i<str.length;i++)hash=(hash<<5)-hash+str.charCodeAt(i),hash&=hash;return Math.abs(hash)}function deepMerge(target,source){var result=__assign({},target);for(var key in source)if(source.hasOwnProperty(key)){var sourceValue=source[key],targetValue=result[key];isObject(sourceValue)&&isObject(targetValue)?result[key]=deepMerge(targetValue,sourceValue):void 0!==sourceValue&&(result[key]=sourceValue)}return result}function isObject(value){return null!==value&&"object"==typeof value&&!Array.isArray(value)}"function"==typeof SuppressedError&&SuppressedError;var EventEmitter=function(){function EventEmitter(){this._events=new Map}return EventEmitter.prototype.on=function(event,callback){this._events.has(event)||this._events.set(event,[]),this._events.get(event).push(callback)},EventEmitter.prototype.off=function(event,callback){var listeners=this._events.get(event);if(listeners){var index=listeners.indexOf(callback);index>-1&&listeners.splice(index,1),0===listeners.length&&this._events.delete(event)}},EventEmitter.prototype.emit=function(event){for(var args=[],_i=1;_i<arguments.length;_i++)args[_i-1]=arguments[_i];var listeners=this._events.get(event);listeners&&__spreadArray([],listeners,!0).forEach(function(callback){try{callback.apply(void 0,args)}catch(error){"production"!==process.env.NODE_ENV&&console.error("Event listener error:",error)}})},EventEmitter.prototype.once=function(event,callback){var _this=this,onceWrapper=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];callback.apply(void 0,args),_this.off(event,onceWrapper)};this.on(event,onceWrapper)},EventEmitter.prototype.removeAllListeners=function(event){event?this._events.delete(event):this._events.clear()},EventEmitter.prototype.listenerCount=function(event){var listeners=this._events.get(event);return listeners?listeners.length:0},EventEmitter.prototype.eventNames=function(){return Array.from(this._events.keys())},EventEmitter}(),Storage=function(){function Storage(prefix){void 0===prefix&&(prefix="opt_"),this._fallback=new Map,this._prefix=prefix}return Storage.prototype.get=function(key){var prefixedKey=this._prefix+key;try{if(isBrowser()&&window.localStorage&&null!==(value=localStorage.getItem(prefixedKey))){if((parsed=safeJsonParse(value,null))&&this._isNotExpired(parsed.expiry))return parsed.value;parsed&&localStorage.removeItem(prefixedKey)}}catch(e){}try{var value,parsed;if(isBrowser()&&window.sessionStorage&&null!==(value=sessionStorage.getItem(prefixedKey))&&(parsed=safeJsonParse(value,null))&&this._isNotExpired(parsed.expiry))return parsed.value}catch(e){}try{if(isBrowser()){var cookieValue=this._getCookie(prefixedKey);if(cookieValue)return cookieValue}}catch(e){}return this._fallback.get(prefixedKey)||null},Storage.prototype.set=function(key,value,expiry){var _this=this,prefixedKey=this._prefix+key,storageValue=safeJsonStringify({value:value,expiry:expiry});try{if(isBrowser()&&window.localStorage)return void localStorage.setItem(prefixedKey,storageValue)}catch(e){}try{if(isBrowser()&&window.sessionStorage)return void sessionStorage.setItem(prefixedKey,storageValue)}catch(e){}try{if(isBrowser()&&value.length<4e3)return void this._setCookie(prefixedKey,value,expiry)}catch(e){}this._fallback.set(prefixedKey,value),this._fallback.size>100&&Array.from(this._fallback.entries()).slice(0,20).forEach(function(_a){var k=_a[0];return _this._fallback.delete(k)})},Storage.prototype.remove=function(key){var prefixedKey=this._prefix+key;try{isBrowser()&&window.localStorage&&localStorage.removeItem(prefixedKey)}catch(e){}try{isBrowser()&&window.sessionStorage&&sessionStorage.removeItem(prefixedKey)}catch(e){}try{isBrowser()&&this._deleteCookie(prefixedKey)}catch(e){}this._fallback.delete(prefixedKey)},Storage.prototype.clear=function(){var _this=this;this._getAllKeys().forEach(function(key){return _this.remove(key.replace(_this._prefix,""))}),this._fallback.clear()},Storage.prototype._isNotExpired=function(expiry){return!expiry||Date.now()<expiry},Storage.prototype._getAllKeys=function(){var _this=this,keys=[];try{if(isBrowser()&&window.localStorage)for(var i=0;i<localStorage.length;i++)(key=localStorage.key(i))&&key.startsWith(this._prefix)&&keys.push(key)}catch(e){}try{if(isBrowser()&&window.sessionStorage)for(i=0;i<sessionStorage.length;i++){var key;(key=sessionStorage.key(i))&&key.startsWith(this._prefix)&&keys.push(key)}}catch(e){}return this._fallback.forEach(function(_,key){key.startsWith(_this._prefix)&&keys.push(key)}),Array.from(new Set(keys))},Storage.prototype._getCookie=function(name){var _a;if(!isBrowser())return null;var parts="; ".concat(document.cookie).split("; ".concat(name,"="));if(2===parts.length){var cookieValue=null===(_a=parts.pop())||void 0===_a?void 0:_a.split(";").shift();return cookieValue?decodeURIComponent(cookieValue):null}return null},Storage.prototype._setCookie=function(name,value,expiry){if(isBrowser()){var cookieString="".concat(name,"=").concat(encodeURIComponent(value),"; path=/");if(expiry){var expiryDate=new Date(expiry);cookieString+="; expires=".concat(expiryDate.toUTCString())}"https:"===location.protocol&&(cookieString+="; secure"),cookieString+="; samesite=lax",document.cookie=cookieString}},Storage.prototype._deleteCookie=function(name){isBrowser()&&(document.cookie="".concat(name,"=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;"))},Storage}(),Tracker=function(_super){function Tracker(){var _this=_super.call(this)||this;return _this.isInitialized=!1,_this._modules=new Map,_this._eventQueue=[],_this._destroyed=!1,_this._storage=new Storage,_this.config={apiUrl:"",projectId:"",debug:!1,enableGDPR:!0,sessionTimeout:18e5,batchSize:10,flushInterval:5e3,platform:"auto"},_this.session=_this._createEmptySession(),_this}return function(d,b){if("function"!=typeof b&&null!==b)throw new TypeError("Class extends value "+String(b)+" is not a constructor or null");function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}(Tracker,_super),Tracker.prototype.init=function(config){var _this=this;if(this.isInitialized)this.config.debug&&console.warn("Tracker already initialized");else{if(this.config=deepMerge(this.config,config),!this.config.apiUrl||!this.config.projectId)throw new Error("apiUrl and projectId are required");this._storage=new Storage("opt_".concat(this.config.projectId,"_")),this._initializeSession(),this._startFlushTimer(),isBrowser()&&domReady(function(){_this.pageView()}),this.isInitialized=!0,this.emit("initialized",this.config),this.config.debug&&console.log("Tracker initialized",{config:this.config,session:this.session})}},Tracker.prototype.track=function(event,data){if(void 0===data&&(data={}),this.isInitialized)if(this.hasConsent()){var eventData={type:"custom",element:event,value:data,timestamp:now(),sessionId:this.session.sessionId,visitorId:this.session.visitorId,metadata:data};this._queueEvent(eventData),this.emit("track",eventData),this.config.debug&&console.log("Event tracked",eventData)}else this.config.debug&&console.warn("No consent for tracking");else this.config.debug&&console.warn("Tracker not initialized")},Tracker.prototype.identify=function(visitorId,traits){void 0===traits&&(traits={}),this.isInitialized&&(this.session.visitorId=visitorId,this._saveSession(),this.track("identify",{visitorId:visitorId,traits:traits}),this.emit("identify",{visitorId:visitorId,traits:traits}))},Tracker.prototype.pageView=function(data){if(void 0===data&&(data={}),this.isInitialized&&this.hasConsent()){var pageViewData=__assign({url:getCurrentUrl(),title:getCurrentTitle(),timestamp:now(),sessionId:this.session.sessionId,visitorId:this.session.visitorId,referrer:getReferrer()},data);this.session.pageViews++,this.session.lastActivity=now(),this._saveSession(),this._queueEvent({type:"pageview",element:pageViewData.url,value:pageViewData.title,timestamp:pageViewData.timestamp,sessionId:pageViewData.sessionId,visitorId:pageViewData.visitorId,metadata:pageViewData}),this.emit("pageview",pageViewData),this.config.debug&&console.log("Page view tracked",pageViewData)}},Tracker.prototype.use=function(module){this._modules.has(module.name)?this.config.debug&&console.warn("Module ".concat(module.name," already registered")):(this._modules.set(module.name,module),this.isInitialized&&module.init(),this.emit("module:added",module))},Tracker.prototype.getModule=function(name){return this._modules.get(name)||null},Tracker.prototype.setConsent=function(consent){this._storage.set("consent",JSON.stringify(consent)),this.emit("consent:changed",consent),this.config.debug&&console.log("Consent updated",consent)},Tracker.prototype.hasConsent=function(){if(!this.config.enableGDPR)return!0;var consentData=this._storage.get("consent");if(!consentData)return!1;try{var consent=JSON.parse(consentData);return consent.hasConsent&&consent.purposes.analytics}catch(_a){return!1}},Tracker.prototype.flush=function(){return __awaiter(this,void 0,void 0,function(){var events,error_1,_a;return __generator(this,function(_b){switch(_b.label){case 0:if(0===this._eventQueue.length)return[2];events=__spreadArray([],this._eventQueue,!0),this._eventQueue=[],_b.label=1;case 1:return _b.trys.push([1,3,,4]),[4,this._sendEvents(events)];case 2:return _b.sent(),this.emit("events:sent",events),[3,4];case 3:return error_1=_b.sent(),(_a=this._eventQueue).unshift.apply(_a,events),this.emit("events:failed",error_1),this.config.debug&&console.error("Failed to send events",error_1),[3,4];case 4:return[2]}})})},Tracker.prototype.destroy=function(){this._destroyed||(this._flushTimer&&clearInterval(this._flushTimer),this.flush().catch(function(){}),this._modules.forEach(function(module){module.destroy&&module.destroy()}),this._modules.clear(),this.removeAllListeners(),this._destroyed=!0,this.isInitialized=!1)},Tracker.prototype._initializeSession=function(){var existingSession=this._storage.get("session");if(existingSession)try{var sessionData=JSON.parse(existingSession);if(now()-sessionData.lastActivity<this.config.sessionTimeout)return this.session=sessionData,this.session.lastActivity=now(),void this._saveSession()}catch(_a){}this.session=this._createNewSession(),this._saveSession()},Tracker.prototype._createNewSession=function(){var visitorId=this._storage.get("visitorId")||generateVisitorId();return this._storage.set("visitorId",visitorId),{sessionId:generateSessionId(),visitorId:visitorId,startTime:now(),lastActivity:now(),pageViews:0,platform:"auto"===this.config.platform?detectPlatform():this.config.platform,userAgent:getUserAgent(),referrer:getReferrer(),landingPage:getCurrentUrl()}},Tracker.prototype._createEmptySession=function(){return{sessionId:"",visitorId:"",startTime:0,lastActivity:0,pageViews:0,platform:"",userAgent:"",landingPage:""}},Tracker.prototype._saveSession=function(){this._storage.set("session",JSON.stringify(this.session))},Tracker.prototype._queueEvent=function(event){this._eventQueue.push(event),this._eventQueue.length>=this.config.batchSize&&this.flush().catch(function(){})},Tracker.prototype._startFlushTimer=function(){var _this=this;this._flushTimer&&clearInterval(this._flushTimer),this._flushTimer=window.setInterval(function(){_this._eventQueue.length>0&&_this.flush().catch(function(){})},this.config.flushInterval)},Tracker.prototype._sendEvents=function(events){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return this.config.debug&&console.log("Sending events",events),[4,new Promise(function(resolve){return setTimeout(resolve,100)})];case 1:return _a.sent(),[2]}})})},Tracker}(EventEmitter),globalTracker=null;function init(config){return globalTracker||(globalTracker=new Tracker),globalTracker.init(config),globalTracker}function getTracker(){return globalTracker}function track(event,data){globalTracker&&globalTracker.track(event,data)}function pageView(data){globalTracker&&globalTracker.pageView(data)}function identify(visitorId,traits){globalTracker&&globalTracker.identify(visitorId,traits)}function setConsent(consent){globalTracker&&globalTracker.setConsent(consent)}function createTracker(){return new Tracker}if(isBrowser()){var globalWindow=window;globalWindow.optimizelyConfig&&init(globalWindow.optimizelyConfig),globalWindow.Optimizely={init:init,getTracker:getTracker,track:track,pageView:pageView,identify:identify,setConsent:setConsent,createTracker:createTracker,Tracker:Tracker}}var index={init:init,getTracker:getTracker,track:track,pageView:pageView,identify:identify,setConsent:setConsent,createTracker:createTracker,Tracker:Tracker};export{EventEmitter,Storage,Tracker,addEventListener,createTracker,debounce,deepMerge,index as default,detectBrowser,detectPlatform,domReady,generateSessionId,generateVisitorId,getCurrentTitle,getCurrentUrl,getReferrer,getScrollDepth,getTracker,getUserAgent,identify,init,isBrowser,isElementVisible,isProduction,now,pageView,safeJsonParse,safeJsonStringify,setConsent,simpleHash,throttle,track};
//# sourceMappingURL=tracker.esm.js.map
